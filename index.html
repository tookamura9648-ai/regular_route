<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>区域 × 新聞種 選択（順路帳起動）</title>
<style>
  :root { --top-bar-height: 70px; }
  body { margin:0; font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; background:#f4f4f8; color:#222; }

  #top-bar{
    height:var(--top-bar-height);
    display:flex; align-items:center;
    padding:6px 10px; box-sizing:border-box;
    background:#333; color:#fff; font-size:13px;
    gap:10px; flex-wrap:wrap;
  }
  #top-bar-left,#top-bar-center,#top-bar-right{ display:flex; align-items:center; gap:6px; }
  #top-bar-center{ flex-direction:column; align-items:flex-start; gap:10px; }
  #top-bar-right{ margin-left:auto; }

  #top-bar button,#top-bar label,#top-bar select{
    padding:4px 8px; border-radius:6px; border:none; font-size:12px; white-space:nowrap;
  }
  #top-bar button,#top-bar label{ background:#fff; color:#333; font-weight:bold; cursor:pointer; }
  #top-bar select{ background:#fafafa; color:#222; border:1px solid #ccc; }
  #csvFile{ display:none; }
  #status{ font-size:11px; opacity:.9; }

  #main{
    height:calc(100vh - var(--top-bar-height));
    box-sizing:border-box; padding:8px;
    display:flex; flex-direction:column;
  }
  #summary{ font-size:13px; margin-bottom:6px; }
  #list{
    flex:1; overflow-y:auto;
    border-radius:10px; background:#fff;
    padding:6px; box-shadow:0 4px 12px rgba(0,0,0,0.07);
    box-sizing:border-box;
  }

  .row{ padding:6px 4px; border-bottom:1px solid #eee; font-size:13px; }
  .row:last-child{ border-bottom:none; }
  .row-header{ font-weight:bold; font-size:12px; color:#555; display:flex; gap:8px; flex-wrap:wrap; margin-bottom:2px; }
  .row-main{ display:flex; flex-wrap:wrap; gap:6px; }
  .chip{ display:inline-block; padding:1px 6px; border-radius:999px; font-size:11px; background:#eee; color:#333; }
  .chip-area{ background:#e0f2ff; }
  .chip-type{ background:#ffe9c7; }
  .name{ font-weight:bold; }
  .addr{ opacity:.9; }
  .note{ font-size:11px; color:#666; margin-top:2px; }

  #startBtn{ margin-left:8px; background:#4caf50; color:#fff; }

  @media (max-width: 600px){
    #top-bar{ height:auto; }
    #main{ height:auto; min-height:calc(100vh - 70px); }
  }

  /* ===== 表紙（3秒） ===== */
  #coverSplash{
    position: fixed; inset:0; z-index:3000;
    display:flex; align-items:center; justify-content:center;
    background: radial-gradient(ellipse at center, rgba(40,40,40,1), rgba(0,0,0,1));
    color:#fff;
    opacity:1;
    pointer-events:none;
    transition: opacity 1.2s ease;
  }
  #coverSplash.fadeout{ opacity:0; }

  .cover-inner{ text-align:center; animation: coverFadeIn 1.2s ease both; }
  @keyframes coverFadeIn{
    from{ opacity:0; transform: translateY(8px); }
    to{ opacity:1; transform: translateY(0); }
  }
  .cover-logo{ max-width:180px; max-height:180px; margin-bottom:18px; opacity:.95; }
  .cover-title{ font-size:28px; font-weight:900; letter-spacing:.6px; }
  .cover-sub{ margin-top:6px; font-size:13px; opacity:.85; letter-spacing:.2px; }

  /* ===== ボタン式フィルタUI ===== */
.filterBlock{
  display:flex;
  flex-direction:column;
  gap:8px;
}

.filterLabel{
  font-size:12px;
  opacity:.95;
}

.btnGrid{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
}

/* 形だけボタン：サイズ統一 */
.pillBtn{
  appearance:none;
  border:1px solid rgba(255,255,255,.35);
  background: rgba(255,255,255,.10);
  color:#fff;
  border-radius: 10px;
  height: 34px;                /* ★高さ統一 */
  min-width: 92px;             /* ★幅の最低値 */
  padding: 0 12px;
  font-weight: 800;
  font-size: 12px;
  letter-spacing:.2px;
  cursor:pointer;
  user-select:none;
}

/* 選択状態 */
.pillBtn.active{
  background:#fff;
  color:#222;
  border-color:#fff;
}

/* 実行ボタン（同サイズ） */
.pillBtn.primary{
  background:#4caf50;
  border-color:#4caf50;
  color:#fff;
}
.pillBtn.primary.active{
  background:#4caf50;
  border-color:#4caf50;
  color:#fff;
}

/* リセット */
.pillBtn.ghost{
  background: rgba(255,255,255,.10);
  border-color: rgba(255,255,255,.35);
  color:#fff;
}

/* 小さい画面でも見やすく */
@media (max-width: 600px){
  .pillBtn{ min-width: 84px; }
}

</style>
</head>
<body>

<!-- 表紙（毎回3秒） -->
<div id="coverSplash" aria-hidden="true">
  <div class="cover-inner">
    <img src="./earth7.jpg" alt="Corporate Logo" class="cover-logo">
    <div class="cover-title">配達ナビゲーション</div>
    <div class="cover-sub">YS_Media</div>
  </div>
</div>

<div id="top-bar">
  <div id="top-bar-left">
    <button id="reloadGitHub">CSV再読込</button>
    <label for="csvFile">ローカルCSV</label>
    <input id="csvFile" type="file" accept=".csv">
  </div>

  <div id="top-bar-center" class="filterBlock">

  <div class="filterLabel">区域（複数選択OK）:</div>
  <div id="areaButtons" class="btnGrid"></div>

  <div class="filterLabel">新聞種（1つ選択）:</div>
  <div id="typeButtons" class="btnGrid"></div>

  <div class="btnGrid">
    <button id="startBtn" class="pillBtn primary">この条件で順路帳を開く</button>
    <button id="clearBtn" class="pillBtn ghost">選択クリア</button>
  </div>

</div>


  <div id="top-bar-right">
    <div id="status">CSV未読み込み</div>
  </div>
</div>

<div id="main">
  <div id="summary">件数: 0件</div>
  <div id="list"></div>
</div>

<script>
/* ===== CSVの場所：Vercelに置いたCSVを読む（おすすめ） ===== */
const CSV_URL = "./regular_route/住所録2025.csv";

let entries = [];
let filteredEntries = [];

const fileInput  = document.getElementById("csvFile");
const statusEl   = document.getElementById("status");
const reloadBtn  = document.getElementById("reloadGitHub");
const listEl     = document.getElementById("list");
const summaryEl  = document.getElementById("summary");
const startBtn   = document.getElementById("startBtn");
const areaButtonsEl = document.getElementById("areaButtons");
const typeButtonsEl = document.getElementById("typeButtons");
const clearBtn      = document.getElementById("clearBtn");

// 状態：区域は複数、新聞種は1つ
let selectedAreas = new Set();      // 例: {"1A","2B"}
let selectedType  = "";             // "", "morning", "evening"


/* ===== 表紙：3秒でフェード→DOM削除 ===== */
window.addEventListener("load", ()=>{
  const cover = document.getElementById("coverSplash");
  const SHOW_MS = 3000;
  setTimeout(()=>{
    cover.classList.add("fadeout");
    setTimeout(()=> cover.remove(), 1500);
  }, SHOW_MS);
});

/* ===== CSV読み込み ===== */
async function loadCsv(){
  statusEl.textContent = "CSV読み込み中…";
  try{
    const res = await fetch(CSV_URL, { cache:"no-cache" });
    if(!res.ok) throw new Error("HTTP " + res.status);
    const text = await res.text();
    const parsed = parseCsvToEntries(text);
    entries = parsed;
    statusEl.textContent = `読み込み完了（${entries.length}件）`;
    initFilters();
    applyFilterAndRender();
  }catch(e){
    console.error(e);
    statusEl.textContent = "CSV読み込みに失敗しました。パスや公開設定を確認してください。";
    entries = [];
    initFilters();
    applyFilterAndRender();
  }
}

reloadBtn.addEventListener("click", loadCsv);

/* ローカルCSV */
fileInput.addEventListener("change",(e)=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = (ev)=>{
    const text = ev.target.result;
    const parsed = parseCsvToEntries(text);
    if(parsed.length === 0){ alert("有効なデータがありませんでした。"); return; }
    entries = parsed;
    statusEl.textContent = `ローカルCSVを読み込みました（${entries.length}件）`;
    initFilters();
    applyFilterAndRender();
  };
  reader.readAsText(file, "Shift_JIS");
});

/* CSVパーサ */
function parseCSV(text){
  const rows=[]; let row=[]; let field=""; let inQuotes=false;
  for(let i=0;i<text.length;i++){
    const c=text[i];
    if(c === '"'){
      if(inQuotes && text[i+1] === '"'){ field+='"'; i++; }
      else inQuotes = !inQuotes;
    }else if(c === "," && !inQuotes){
      row.push(field); field="";
    }else if((c === "\n" || c === "\r") && !inQuotes){
      if(c === "\r" && text[i+1] === "\n") i++;
      row.push(field); rows.push(row);
      row=[]; field="";
    }else{
      field += c;
    }
  }
  if(field.length>0 || row.length>0){ row.push(field); rows.push(row); }
  return rows;
}

/**
 *  購読者番号,新聞種類,名前,地名,番地,建物,緯度,経度,区域,備考
 */
function parseCsvToEntries(csvText){
  const rows = parseCSV(csvText);
  const result = [];

  rows.forEach((colsRaw, idx)=>{
    const cols = colsRaw.map(c => (c||"").trim());
    if(cols.every(c=>c==="")) return;

    const joined = cols.join("");
    if(idx===0 && /購読|番号|新聞|種類|名前|氏名|地名|番地|建物|住所|緯度|経度|区域|備考|area|note/i.test(joined)) return;

    const no    = cols[0] || "";
    const type  = cols[1] || "";
    const name  = cols[2] || "";
    const addr1 = cols[3] || "";
    const addr2 = cols[4] || "";
    const addr3 = cols[5] || "";

    if(!no && !name) return;

    let lat=null,lng=null;
    if(cols.length>=8){
      const latNum = Number((cols[6]||"").replace(/,/g,""));
      const lngNum = Number((cols[7]||"").replace(/,/g,""));
      if(!Number.isNaN(latNum) && !Number.isNaN(lngNum)){ lat=latNum; lng=lngNum; }
    }

    const area = cols[8] || "";
    const note = cols[9] || "";
    result.push({ no,type,name,addr1,addr2,addr3,lat,lng,area,note });
  });

  return result;
}

/* フィルタ初期化 */
function initFilters(){
  // 区域一覧
  const areas = Array.from(new Set(entries.map(e=>e.area).filter(Boolean))).sort();

  // ---- 区域ボタン（複数選択） ----
  areaButtonsEl.innerHTML = "";
  // 全て（=未選択扱い）ボタン
  areaButtonsEl.appendChild(makePillButton("すべて", () => {
    selectedAreas.clear();
    syncAreaButtons();
    applyFilterAndRender();
  }, selectedAreas.size===0));

  areas.forEach(a=>{
    areaButtonsEl.appendChild(makePillButton(a, () => {
      if(selectedAreas.has(a)) selectedAreas.delete(a);
      else selectedAreas.add(a);
      syncAreaButtons();
      applyFilterAndRender();
    }, selectedAreas.has(a)));
  });

  // ---- 新聞種ボタン（単一選択）----
  typeButtonsEl.innerHTML = "";
  typeButtonsEl.appendChild(makePillButton("指定なし", () => {
    selectedType = "";
    syncTypeButtons();
    applyFilterAndRender();
  }, selectedType===""));

  typeButtonsEl.appendChild(makePillButton("朝刊", () => {
    selectedType = "morning";
    syncTypeButtons();
    applyFilterAndRender();
  }, selectedType==="morning"));

  typeButtonsEl.appendChild(makePillButton("夕刊あり", () => {
    selectedType = "evening";
    syncTypeButtons();
    applyFilterAndRender();
  }, selectedType==="evening"));

  // クリア
  clearBtn.onclick = () => {
    selectedAreas.clear();
    selectedType = "";
    syncAreaButtons();
    syncTypeButtons();
    applyFilterAndRender();
  };
}

function makePillButton(label, onClick, active=false){
  const btn = document.createElement("button");
  btn.type = "button";
  btn.className = "pillBtn" + (active ? " active" : "");
  btn.textContent = label;
  btn.addEventListener("click", onClick);
  return btn;
}

function syncAreaButtons(){
  // 先頭「すべて」ボタン含めて全部更新
  const buttons = Array.from(areaButtonsEl.querySelectorAll("button"));
  buttons.forEach(btn=>{
    const label = btn.textContent;
    if(label === "すべて"){
      btn.classList.toggle("active", selectedAreas.size===0);
    }else{
      btn.classList.toggle("active", selectedAreas.has(label));
    }
  });
}

function syncTypeButtons(){
  const buttons = Array.from(typeButtonsEl.querySelectorAll("button"));
  buttons.forEach(btn=>{
    const label = btn.textContent;
    let active = false;
    if(label==="指定なし") active = (selectedType==="");
    if(label==="朝刊") active = (selectedType==="morning");
    if(label==="夕刊あり") active = (selectedType==="evening");
    btn.classList.toggle("active", active);
  });
}


function hasEvening(typeStr){ return /よセ|日経セ|日経代/.test(typeStr || ""); }
function matchTypeFilter(typeVal, entryType){
  if(!typeVal) return true;
  const evening = hasEvening(entryType);
  if(typeVal === "evening") return evening;
  if(typeVal === "morning") return !evening;
  return true;
}

areaFilter.addEventListener("change", applyFilterAndRender);
typeFilter.addEventListener("change", applyFilterAndRender);

function applyFilterAndRender(){
  filteredEntries = entries.filter(e=>{
    // 区域：未選択なら全て、選択ありならその中だけ
    if(selectedAreas.size > 0 && !selectedAreas.has(e.area)) return false;

    // 新聞種：指定なしなら全て
    if(!matchTypeFilter(selectedType, e.type || "")) return false;

    return true;
  });

  renderList();
}


function renderList(){
  listEl.innerHTML = "";
  summaryEl.textContent = `件数: ${filteredEntries.length}件（全体: ${entries.length}件）`;

  if(filteredEntries.length===0){
    listEl.textContent = "該当するデータがありません。";
    return;
  }

  filteredEntries.forEach(e=>{
    const row=document.createElement("div");
    row.className="row";

    const header=document.createElement("div");
    header.className="row-header";
    header.innerHTML = `
      <span>No: ${escapeHtml(e.no)}</span>
      ${e.area ? `<span class="chip chip-area">${escapeHtml(e.area)}</span>` : ""}
      ${e.type ? `<span class="chip chip-type">${escapeHtml(e.type)}</span>` : ""}
    `;

    const main=document.createElement("div");
    main.className="row-main";
    main.innerHTML = `
      <span class="name">${escapeHtml(e.name||"")}</span>
      <span class="addr">${escapeHtml([e.addr1,e.addr2,e.addr3].filter(Boolean).join(" "))}</span>
    `;

    row.appendChild(header);
    row.appendChild(main);

    if(e.note){
      const note=document.createElement("div");
      note.className="note";
      note.textContent = `備考: ${e.note}`;
      row.appendChild(note);
    }

    listEl.appendChild(row);
  });
}

function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
}

/* 順路帳へ */
startBtn.addEventListener("click", ()=>{
  const params = new URLSearchParams();

  // 区域：複数なら a,b,c のようにカンマ区切りで渡す
  if(selectedAreas.size > 0){
    params.set("areas", Array.from(selectedAreas).join(","));
  }

  // 新聞種
  if(selectedType) params.set("type", selectedType);

  const url = params.toString()
    ? `route.html?${params.toString()}`
    : `route.html`;

  window.location.href = url;
});


window.addEventListener("load", loadCsv);
</script>
</body>
</html>



