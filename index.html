<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<title>順路帳＋地図（縦書き・住所3分割版）</title>

<!-- Leaflet（地図ライブラリ） -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js">
</script>

<style>
  :root {
    --top-bar-height: 48px;
  }
  body {
    margin: 0;
    background: #f2f2f2;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    overflow: hidden;
  }

  /* 上部バー（CSV選択など） */
  #top-bar {
    height: var(--top-bar-height);
    display: flex;
    align-items: center;
    padding: 4px 8px;
    box-sizing: border-box;
    background: #333;
    color: #fff;
    font-size: 14px;
  }
  #top-bar label {
    display: inline-block;
    padding: 6px 10px;
    border-radius: 6px;
    background: #fff;
    color: #333;
    font-weight: bold;
    margin-right: 8px;
    cursor: pointer;
  }
  #csvFile {
    display: none;
  }
  #status {
    font-size: 12px;
    opacity: .8;
  }

  /* カード横スクロール */
  #container {
    display: flex;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    height: calc(100vh - var(--top-bar-height));
    white-space: nowrap;
  }

  /* 1ページ＝5件分 */
  .group {
    display: flex;
    flex-direction: row;
    flex: 0 0 100vw;
    scroll-snap-align: start;
    padding: 6px;
    box-sizing: border-box;
  }

  /* 1件のカード */
  .card {
    background: #ffffff;
    margin: 4px;
    flex: 1;
    border-radius: 14px;
    padding: 6px;
    box-sizing: border-box;
    border: solid 2px #444;
    display: flex;
    flex-direction: column;
    align-items: stretch;
    cursor: pointer;
    touch-action: manipulation;
  }

  /* 上部：購読者番号 & 新聞種類（横書き2行） */
  .card-top {
    width: 100%;
    display: flex;
    flex-direction: column;
    font-size: 1.1rem;
    line-height: 1.2;
    margin-bottom: 4px;
  }
  .card-no {
    font-weight: bold;
  }
  .card-type {
    font-size: 0.95rem;
    opacity: 0.9;
  }

  .card-note {
  font-size: 0.85rem;
  color: #666;
  margin-top: 2px;
  line-height: 1.1;
}


  /* 下部：名前＋住所（縦書き） */
  .card-main {
    flex: 1;
    display: flex;
    justify-content: center;
    gap: 4px;
    overflow: hidden;
  }

  .vertical-text {
    writing-mode: vertical-rl;
    text-orientation: mixed;
    white-space: pre-line;
    word-break: break-all;
  }

  .name-text {
    font-size: 1.8rem;
    font-weight: bold;
  }

  /* 住所3分割は名前より少し小さめ */
  .addr-text {
    font-size: 1.2rem;
    opacity: 0.9;
  }

  #container::-webkit-scrollbar {
    height: 4px;
  }
  #container::-webkit-scrollbar-thumb {
    background: #999;
    border-radius: 2px;
  }

  /* 地図オーバーレイ */
  #mapOverlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    display: none;
    z-index: 1000;
  }
  #mapPanel {
    position: absolute;
    top: 5%;
    left: 5%;
    width: 90%;
    height: 90%;
    background: #fff;
    border-radius: 14px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  #mapHeader {
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 8px;
    box-sizing: border-box;
    background: #333;
    color: #fff;
    font-size: 14px;
  }
  #mapTitle {
    flex: 1;
    padding-right: 8px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  #mapClose {
    border: none;
    background: #fff;
    color: #333;
    border-radius: 999px;
    padding: 4px 10px;
    font-weight: bold;
    cursor: pointer;
  }
  #map {
    flex: 1;
  }
</style>
</head>
<body>

<div id="top-bar">
  <label for="csvFile">CSVを選択</label>
  <input id="csvFile" type="file" accept=".csv">
  <div id="status">横向き推奨／1ページ5件表示／タップで地図</div>
</div>

<div id="container"></div>

<!-- 地図オーバーレイ -->
<div id="mapOverlay">
  <div id="mapPanel">
    <div id="mapHeader">
      <div id="mapTitle">地図</div>
      <button id="mapClose">閉じる</button>
    </div>
    <div id="map"></div>
  </div>
</div>

<script>
// ===== データ構造 =====
// { no, type, name, addr1, addr2, addr3, lat, lng, area }
let entries = [
  // ダミーデータ（CSV読み込みで上書きされます）
  {
    no: "A001",
    type: "朝刊",
    name: "山田太郎",
    addr1: "滋賀県草津市◯◯",
    addr2: "1-2-3",
    addr3: "",
    lat: null,
    lng: null,
    area: "南部",
    note: "ヨミポ"
  },
  {
    no: "A002",
    type: "朝夕刊",
    name: "佐藤花子",
    addr1: "滋賀県草津市△△",
    addr2: "5-6-7",
    addr3: "ハイツ101",
    lat: null,
    lng: null,
    area: "南部",
    note: null
  }
];

const fileInput = document.getElementById("csvFile");
const statusEl  = document.getElementById("status");
const container = document.getElementById("container");

// ===== CSV 読み込み =====
fileInput.addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = (ev) => {
    const text = ev.target.result;
    const parsed = parseCsvToEntries(text);
    if (parsed.length === 0) {
      alert("有効なデータがありませんでした。CSVの内容を確認してください。");
      return;
    }
    entries = parsed;
    statusEl.textContent = `${file.name} を読み込みました（${entries.length}件）`;
    renderCards();
  };
  reader.readAsText(file, "UTF-8");
});

/**
 * CSV文字列 → {no,type,name,addr1,addr2,addr3,lat,lng,area}[] に変換
 * 想定フォーマット：
 *   購読者番号,新聞種類,名前,地名,番地,建物,緯度,経度,区域
 * 先頭行にヘッダーらしき語が入っていればスキップ
 */
function parseCsvToEntries(csvText) {
  const lines = csvText.split(/\r?\n/).map(l => l.trim()).filter(l => l);
  const result = [];

  lines.forEach((line, idx) => {
    const cols = line.split(",");
    const joined = cols.join("");

    // ヘッダー判定（1行目だけ）
    if (
      idx === 0 &&
      /購読|番号|新聞|種類|名前|氏名|地名|番地|建物|住所|緯度|経度|区域|area/i.test(joined)
    ) {
      return;
    }

    if (cols.length === 0) return;

    const no    = (cols[0] || "").trim();
    const type  = (cols[1] || "").trim();
    const name  = (cols[2] || "").trim();
    const addr1 = (cols[3] || "").trim(); // 地名
    const addr2 = (cols[4] || "").trim(); // 番地
    const addr3 = (cols[5] || "").trim(); // 建物

    if (!no && !name) return;  // どちらも空ならスキップ

        let lat = null;
    let lng = null;
    if (cols.length >= 8) {
      const latNum = Number((cols[6] || "").trim());
      const lngNum = Number((cols[7] || "").trim());
      if (!Number.isNaN(latNum) && !Number.isNaN(lngNum)) {
        lat = latNum;
        lng = lngNum;
      }
    }

    // ★ 区域をここで取り出す（9番目の列 index 8）
    const area = (cols[8] || "").trim();

    // ★ 備考は10番目の列（index 9）
    const note = (cols[9] || "").trim();

    result.push({ no, type, name, addr1, addr2, addr3, lat, lng, area, note });

  });

  return result;
}


// ===== 5件ずつ分割 =====
function chunk(array, size) {
  const result = [];
  for (let i = 0; i < array.length; i += size) {
    result.push(array.slice(i, i + size));
  }
  return result;
}

// ===== 順路カード表示 =====
function renderCards() {
  container.innerHTML = "";
  const groups = chunk(entries, 5);

  groups.forEach(groupData => {
    const group = document.createElement("div");
    group.className = "group";

    groupData.forEach(item => {
      const card = document.createElement("div");
      card.className = "card";

      // データ属性に格納（地図用）
      card.dataset.no    = item.no || "";
      card.dataset.type  = item.type || "";
      card.dataset.name  = item.name || "";
      card.dataset.addr1 = item.addr1 || "";
      card.dataset.addr2 = item.addr2 || "";
      card.dataset.addr3 = item.addr3 || "";
      if (item.lat != null && item.lng != null) {
        card.dataset.lat  = item.lat;
        card.dataset.lng  = item.lng;
      }
      card.dataset.area = item.area || "";

      // 上部（横書き2行）
      const top = document.createElement("div");
      top.className = "card-top";

      const noEl = document.createElement("div");
      noEl.className = "card-no";
      noEl.textContent = item.no || "";

      const typeEl = document.createElement("div");
      typeEl.className = "card-type";
      typeEl.textContent = item.type || "";

      top.appendChild(noEl);
      top.appendChild(typeEl);
      // 備考
      const noteEl = document.createElement("div");
      noteEl.className = "card-note";
      noteEl.textContent = item.note || "";
      
      // note が空でなければ表示
      if (item.note) {
        top.appendChild(noteEl);
      }


      // 下部（縦書き 名前＋住所3分割）
      const main = document.createElement("div");
      main.className = "card-main";

      const nameEl = document.createElement("div");
      nameEl.className = "vertical-text name-text";
      nameEl.textContent = item.name || "";

      const addr1El = document.createElement("div");
      addr1El.className = "vertical-text addr-text";
      addr1El.textContent = item.addr1 || "";

      const addr2El = document.createElement("div");
      addr2El.className = "vertical-text addr-text";
      addr2El.textContent = item.addr2 || "";

      const addr3El = document.createElement("div");
      addr3El.className = "vertical-text addr-text";
      addr3El.textContent = item.addr3 || "";

      main.appendChild(nameEl);
      main.appendChild(addr1El);
      main.appendChild(addr2El);
      if (item.addr3) {
        main.appendChild(addr3El);
      }

      card.appendChild(top);
      card.appendChild(main);

      // タップで地図表示
      card.addEventListener("click", onCardClick);

      group.appendChild(card);
    });

    // 5件に満たない分は空カードで埋める
    for (let i = groupData.length; i < 5; i++) {
      const empty = document.createElement("div");
      empty.className = "card";
      empty.style.visibility = "hidden";
      group.appendChild(empty);
    }

    container.appendChild(group);
  });
}

// 初期描画
renderCards();

// ====== 地図関連 ======
let map;
let destMarker;
let userMarker;
let geoWatchId = null;
const mapOverlay = document.getElementById("mapOverlay");
const mapTitle   = document.getElementById("mapTitle");
const mapClose   = document.getElementById("mapClose");

mapClose.addEventListener("click", () => {
  mapOverlay.style.display = "none";
});

/**
 * カードタップ時
 */
function onCardClick(e) {
  const card = e.currentTarget;
  const no    = card.dataset.no   || "";
  const name  = card.dataset.name || "";
  const addr1 = card.dataset.addr1 || "";
  const addr2 = card.dataset.addr2 || "";
  const addr3 = card.dataset.addr3 || "";

  const labelMain = `${no} ${name}`.trim();
  const labelAddr = [addr1, addr2, addr3].filter(Boolean).join(" ");
  const label = (labelMain || labelAddr || "地図").slice(0, 40);

  const lat = card.dataset.lat ? Number(card.dataset.lat) : null;
  const lng = card.dataset.lng ? Number(card.dataset.lng) : null;

  if (lat == null || lng == null || Number.isNaN(lat) || Number.isNaN(lng)) {
    alert("この順路には緯度・経度が設定されていません。\nCSVに「購読者番号,新聞種類,名前,地名,番地,建物,緯度,経度,区域」の形式で設定してください。");
    return;
  }

  openMap(label, lat, lng);
}

/**
 * 地図オーバーレイを開く
 */
function openMap(label, lat, lng) {
  mapTitle.textContent = label;
  mapOverlay.style.display = "block";

  // 初回だけ地図初期化
  if (!map) {
    initMap(lat, lng);
  } else {
    map.setView([lat, lng], 17);
  }

  // 配達先マーカー更新
  if (!destMarker) {
    destMarker = L.marker([lat, lng]).addTo(map);
  } else {
    destMarker.setLatLng([lat, lng]);
  }

  // サイズ調整
  setTimeout(() => {
    map.invalidateSize();
  }, 200);
}

/**
 * 地図初期化（国土地理院タイル＋現在地）
 */
function initMap(lat, lng) {
  map = L.map("map");

  // 国土地理院 標準地図
  L.tileLayer(
    "https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png",
    {
      attribution: "地理院タイル",
      maxZoom: 18,
      minZoom: 5
    }
  ).addTo(map);

  map.setView([lat, lng], 17);

  // 現在地追跡開始
  startGeoWatch();
}

/**
 * 現在地監視
 */
function startGeoWatch() {
  if (!navigator.geolocation) {
    console.warn("Geolocation がサポートされていません。");
    return;
  }
  if (geoWatchId != null) return; // 重複開始防止

  geoWatchId = navigator.geolocation.watchPosition(
    pos => {
      const { latitude, longitude } = pos.coords;

      const latlng = [latitude, longitude];

      if (!userMarker) {
        userMarker = L.circleMarker(latlng, {
          radius: 8
        }).addTo(map);
      } else {
        userMarker.setLatLng(latlng);
      }
    },
    err => {
      console.warn("現在地取得に失敗:", err);
    },
    {
      enableHighAccuracy: true,
      maximumAge: 10000,
      timeout: 20000
    }
  );
}
</script>
</body>
</html>


